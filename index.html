<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catur Interaktif dengan WebSocket API</title>
    <style>
        /* Styles tetap sama seperti sebelumnya */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #2c3e50, #1a1a2e);
            color: #ecf0f1;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            color: #f39c12;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .subtitle {
            font-size: 1.2rem;
            color: #bdc3c7;
            margin-bottom: 30px;
        }
        
        .controls {
            background: rgba(44, 62, 80, 0.7);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            min-width: 200px;
        }
        
        .control-group label {
            margin-bottom: 8px;
            font-weight: bold;
            color: #f39c12;
        }
        
        select, button {
            padding: 12px;
            border-radius: 5px;
            border: none;
            background: #34495e;
            color: #ecf0f1;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        select:hover, button:hover {
            background: #3d566e;
            transform: translateY(-2px);
        }
        
        select:focus, button:focus {
            outline: none;
            box-shadow: 0 0 0 2px #f39c12;
        }
        
        button {
            background: #e74c3c;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        button:hover {
            background: #c0392b;
        }
        
        button:disabled {
            background: #7f8c8d;
            cursor: not-allowed;
            transform: none;
        }
        
        .game-container {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            justify-content: center;
        }
        
        .board-container {
            flex: 1;
            min-width: 350px;
            max-width: 600px;
            perspective: 1000px;
        }
        
        .board-2d, .board-3d {
            width: 100%;
            padding-bottom: 100%;
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transition: transform 0.5s ease;
        }
        
        .board-2d {
            display: block;
            background: #f5d7b4;
        }
        
        .board-3d {
            display: none;
            transform-style: preserve-3d;
            transform: rotateX(45deg) rotateZ(45deg) scale(0.9);
        }
        
        .board-2d .square {
            position: absolute;
            width: 12.5%;
            height: 12.5%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .board-2d .light {
            background: #f5d7b4;
        }
        
        .board-2d .dark {
            background: #ca9650;
        }
        
        .board-2d .piece {
            width: 90%;
            height: 90%;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .board-2d .piece:hover {
            transform: scale(1.1);
        }
        
        .board-3d .square {
            position: absolute;
            width: 12.5%;
            height: 12.5%;
            transition: all 0.3s ease;
        }
        
        .board-3d .light {
            background: #f5d7b4;
        }
        
        .board-3d .dark {
            background: #ca9650;
        }
        
        .board-3d .piece {
            position: absolute;
            width: 80%;
            height: 80%;
            top: 10%;
            left: 10%;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5vw;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s ease;
            transform-style: preserve-3d;
            z-index: 10;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }
        
        .board-3d .piece:hover {
            transform: translateY(-5px);
        }
        
        .selected {
            box-shadow: 0 0 0 3px #f39c12, 0 0 10px 5px rgba(243, 156, 18, 0.5);
            z-index: 20;
        }
        
        .possible-move {
            position: absolute;
            width: 30%;
            height: 30%;
            background-color: rgba(46, 204, 113, 0.5);
            border-radius: 50%;
            top: 35%;
            left: 35%;
            z-index: 5;
        }
        
        .info-panel {
            flex: 1;
            min-width: 300px;
            background: rgba(44, 62, 80, 0.7);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .status {
            margin-bottom: 20px;
            padding: 15px;
            background: #34495e;
            border-radius: 8px;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .move-history {
            max-height: 300px;
            overflow-y: auto;
            background: #34495e;
            border-radius: 8px;
            padding: 15px;
        }
        
        .move-history h3 {
            margin-bottom: 10px;
            color: #f39c12;
            text-align: center;
        }
        
        .moves {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .move {
            padding: 8px;
            background: #2c3e50;
            border-radius: 4px;
            text-align: center;
        }
        
        .evaluation {
            margin-top: 20px;
            background: #34495e;
            border-radius: 8px;
            padding: 15px;
        }
        
        .evaluation h3 {
            margin-bottom: 10px;
            color: #f39c12;
            text-align: center;
        }
        
        .eval-bar {
            height: 20px;
            background: #e74c3c;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .eval-fill {
            height: 100%;
            background: #2ecc71;
            width: 50%;
            transition: width 0.5s ease;
        }
        
        .eval-text {
            text-align: center;
            font-weight: bold;
        }
        
        .loading {
            display: none;
            text-align: center;
            margin-top: 20px;
        }
        
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #f39c12;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .game-container {
                flex-direction: column;
            }
            
            .board-container {
                width: 100%;
            }
            
            h1 {
                font-size: 2rem;
            }
        }
        
        .hidden {
            display: none;
        }
        
        .visible {
            display: block;
        }
        
        .error {
            color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 8px;
            border-radius: 5px;
            background: #34495e;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .connected {
            background: #2ecc71;
        }
        
        .disconnected {
            background: #e74c3c;
        }
        
        .connecting {
            background: #f39c12;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Catur Interaktif dengan WebSocket</h1>
            <p class="subtitle">Bermain catur dengan analisis real-time menggunakan WebSocket API</p>
        </header>
        
        <div class="controls">
            <div class="control-group">
                <label for="view-mode">Tampilan Papan:</label>
                <select id="view-mode">
                    <option value="2d">2D Classic</option>
                    <option value="3d">3D Perspective</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="player-side">Pilih Sisi:</label>
                <select id="player-side">
                    <option value="white">Putih (Bermain pertama)</option>
                    <option value="black">Hitam (Bot bermain pertama)</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="difficulty">Tingkat Kesulitan:</label>
                <select id="difficulty">
                    <option value="10">Mudah (Kedalaman 10)</option>
                    <option value="12" selected>Sedang (Kedalaman 12)</option>
                    <option value="15">Sulit (Kedalaman 15)</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>Aksi:</label>
                <button id="new-game">
                    <span>Game Baru</span>
                </button>
                <button id="connect-ws" style="background: #27ae60; margin-top: 10px;">
                    <span>Sambungkan WebSocket</span>
                </button>
            </div>
        </div>
        
        <div class="game-container">
            <div class="board-container">
                <div class="board-2d" id="board-2d">
                    <!-- Papan 2D akan di-generate oleh JavaScript -->
                </div>
                <div class="board-3d" id="board-3d">
                    <!-- Papan 3D akan di-generate oleh JavaScript -->
                </div>
            </div>
            
            <div class="info-panel">
                <div class="connection-status" id="connection-status">
                    <div class="status-indicator disconnected" id="ws-status"></div>
                    <span id="ws-status-text">WebSocket Terputus</span>
                </div>
                
                <div class="status" id="status">
                    Status: Pilih sisi dan mulai game baru
                </div>
                
                <div class="error" id="error-message">
                    Terjadi kesalahan saat mengambil langkah bot. Silakan coba lagi.
                </div>
                
                <div class="move-history">
                    <h3>Riwayat Langkah</h3>
                    <div class="moves" id="move-history">
                        <!-- Riwayat langkah akan diisi oleh JavaScript -->
                    </div>
                </div>
                
                <div class="evaluation">
                    <h3>Evaluasi Posisi</h3>
                    <div class="eval-bar">
                        <div class="eval-fill" id="eval-fill"></div>
                    </div>
                    <div class="eval-text" id="eval-text">0.0 (Setara)</div>
                </div>
                
                <div class="loading" id="loading">
                    <p>Bot sedang berpikir...</p>
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Konstanta dan variabel global
            const BOARD_SIZE = 8;
            const PIECE_IMAGES = {
                'white': {
                    'king': 'https://images.chesscomfiles.com/chess-themes/pieces/neo/150/wk.png',
                    'queen': 'https://images.chesscomfiles.com/chess-themes/pieces/neo/150/wq.png',
                    'rook': 'https://images.chesscomfiles.com/chess-themes/pieces/neo/150/wr.png',
                    'bishop': 'https://images.chesscomfiles.com/chess-themes/pieces/neo/150/wb.png',
                    'knight': 'https://images.chesscomfiles.com/chess-themes/pieces/neo/150/wn.png',
                    'pawn': 'https://images.chesscomfiles.com/chess-themes/pieces/neo/150/wp.png'
                },
                'black': {
                    'king': 'https://images.chesscomfiles.com/chess-themes/pieces/neo/150/bk.png',
                    'queen': 'https://images.chesscomfiles.com/chess-themes/pieces/neo/150/bq.png',
                    'rook': 'https://images.chesscomfiles.com/chess-themes/pieces/neo/150/br.png',
                    'bishop': 'https://images.chesscomfiles.com/chess-themes/pieces/neo/150/bb.png',
                    'knight': 'https://images.chesscomfiles.com/chess-themes/pieces/neo/150/bn.png',
                    'pawn': 'https://images.chesscomfiles.com/chess-themes/pieces/neo/150/bp.png'
                }
            };
            
            const initialPosition = [
                ['r', 'n', 'b', 'q', 'k', 'b', 'n', 'r'],
                ['p', 'p', 'p', 'p', 'p', 'p', 'p', 'p'],
                ['', '', '', '', '', '', '', ''],
                ['', '', '', '', '', '', '', ''],
                ['', '', '', '', '', '', '', ''],
                ['', '', '', '', '', '', '', ''],
                ['P', 'P', 'P', 'P', 'P', 'P', 'P', 'P'],
                ['R', 'N', 'B', 'Q', 'K', 'B', 'N', 'R']
            ];
            
            let boardData = JSON.parse(JSON.stringify(initialPosition));
            let selectedPiece = null;
            let selectedElement = null;
            let currentPlayer = 'white';
            let playerSide = 'white';
            let moveHistory = [];
            let gameActive = false;
            let chessSocket = null;
            let isWebSocketConnected = false;
            
            // Elemen DOM
            const viewModeSelect = document.getElementById('view-mode');
            const playerSideSelect = document.getElementById('player-side');
            const difficultySelect = document.getElementById('difficulty');
            const newGameBtn = document.getElementById('new-game');
            const connectWsBtn = document.getElementById('connect-ws');
            const statusDiv = document.getElementById('status');
            const errorDiv = document.getElementById('error-message');
            const moveHistoryDiv = document.getElementById('move-history');
            const evalFillDiv = document.getElementById('eval-fill');
            const evalTextDiv = document.getElementById('eval-text');
            const loadingDiv = document.getElementById('loading');
            const board2d = document.getElementById('board-2d');
            const board3d = document.getElementById('board-3d');
            const wsStatusIndicator = document.getElementById('ws-status');
            const wsStatusText = document.getElementById('ws-status-text');
            const connectionStatusDiv = document.getElementById('connection-status');
            
            // Fungsi untuk menghubungkan WebSocket
            function connectWebSocket() {
                try {
                    updateWebSocketStatus('connecting', 'Menghubungkan...');
                    
                    // Tutup koneksi sebelumnya jika ada
                    if (chessSocket) {
                        chessSocket.close();
                    }
                    
                    // Buat koneksi WebSocket baru
                    chessSocket = new WebSocket('wss://chess-api.com/v1');
                    
                    // Event handler untuk koneksi terbuka
                    chessSocket.onopen = function(event) {
                        console.log('WebSocket connected:', event);
                        updateWebSocketStatus('connected', 'WebSocket Terhubung');
                        isWebSocketConnected = true;
                        
                        // Kirim pesan test setelah koneksi terbuka
                        const testMessage = JSON.stringify({
                            fen: 'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1',
                            depth: 10
                        });
                        
                        // Tunggu sebentar sebelum mengirim pesan
                        setTimeout(() => {
                            if (chessSocket.readyState === WebSocket.OPEN) {
                                chessSocket.send(testMessage);
                            }
                        }, 1000);
                    };
                    
                    // Event handler untuk menerima pesan
                    chessSocket.onmessage = function(event) {
                        try {
                            const data = JSON.parse(event.data);
                            console.log('Received WebSocket message:', data);
                            
                            // Proses respons berdasarkan tipe
                            if (data.type === 'bestmove' && data.move) {
                                // Terima langkah terbaik dari bot
                                processBotMove(data.move);
                            } else if (data.eval !== undefined) {
                                // Perbarui evaluasi
                                updateEvaluation(data.eval);
                            }
                        } catch (error) {
                            console.error('Error parsing WebSocket message:', error);
                        }
                    };
                    
                    // Event handler untuk error
                    chessSocket.onerror = function(error) {
                        console.error('WebSocket error:', error);
                        updateWebSocketStatus('disconnected', 'Error Koneksi WebSocket');
                        isWebSocketConnected = false;
                        showError('Error koneksi WebSocket. Silakan coba lagi.');
                    };
                    
                    // Event handler untuk koneksi tertutup
                    chessSocket.onclose = function(event) {
                        console.log('WebSocket closed:', event);
                        updateWebSocketStatus('disconnected', 'WebSocket Terputus');
                        isWebSocketConnected = false;
                        
                        // Coba sambungkan ulang jika tidak ditutup secara sengaja
                        if (event.code !== 1000) {
                            setTimeout(connectWebSocket, 3000);
                        }
                    };
                    
                } catch (error) {
                    console.error('Error connecting WebSocket:', error);
                    updateWebSocketStatus('disconnected', 'Gagal Terhubung');
                    isWebSocketConnected = false;
                    showError('Gagal menghubungkan WebSocket: ' + error.message);
                }
            }
            
            // Fungsi untuk memperbarui status WebSocket UI
            function updateWebSocketStatus(status, text) {
                wsStatusIndicator.className = 'status-indicator ' + status;
                wsStatusText.textContent = text;
                
                if (status === 'connected') {
                    connectionStatusDiv.style.backgroundColor = 'rgba(46, 204, 113, 0.2)';
                } else if (status === 'connecting') {
                    connectionStatusDiv.style.backgroundColor = 'rgba(243, 156, 18, 0.2)';
                } else {
                    connectionStatusDiv.style.backgroundColor = 'rgba(231, 76, 60, 0.2)';
                }
            }
            
            // Fungsi untuk mengirim permintaan analisis posisi ke WebSocket
            function requestAnalysis(fen) {
                if (!chessSocket || chessSocket.readyState !== WebSocket.OPEN) {
                    showError('WebSocket tidak terhubung. Silakan sambungkan terlebih dahulu.');
                    return false;
                }
                
                const depth = parseInt(difficultySelect.value);
                
                const analysisRequest = {
                    fen: fen,
                    depth: depth,
                    variants: 1
                };
                
                try {
                    chessSocket.send(JSON.stringify(analysisRequest));
                    return true;
                } catch (error) {
                    console.error('Error sending analysis request:', error);
                    showError('Gagal mengirim permintaan analisis: ' + error.message);
                    return false;
                }
            }
            
            // Fungsi untuk memproses langkah bot
            function processBotMove(move) {
                // Parse move (format: "e2e4" atau "b7b8q" untuk promosi)
                const fromCol = move.charCodeAt(0) - 97; // a->0, b->1, ...
                const fromRow = 8 - parseInt(move.charAt(1)); // 1->7, 2->6, ...
                let toCol, toRow;
                let promotion = null;
                
                // Handle promosi (e.g., "b7b8q")
                if (move.length > 4) {
                    toCol = move.charCodeAt(2) - 97;
                    toRow = 8 - parseInt(move.charAt(3));
                    promotion = move.charAt(4); // q, r, b, n
                } else {
                    toCol = move.charCodeAt(2) - 97;
                    toRow = 8 - parseInt(move.charAt(3));
                }
                
                // Validasi koordinat
                if (isNaN(fromRow) || isNaN(fromCol) || isNaN(toRow) || isNaN(toCol) ||
                    fromRow < 0 || fromRow >= BOARD_SIZE || fromCol < 0 || fromCol >= BOARD_SIZE ||
                    toRow < 0 || toRow >= BOARD_SIZE || toCol < 0 || toCol >= BOARD_SIZE) {
                    console.error('Move tidak valid:', move);
                    showError('Langkah bot tidak valid: ' + move);
                    return;
                }
                
                // Lakukan move
                const piece = boardData[fromRow][fromCol];
                if (!piece) {
                    console.error('Tidak ada bidak di posisi awal:', move);
                    showError('Tidak ada bidak di posisi awal: ' + move);
                    return;
                }
                
                boardData[fromRow][fromCol] = '';
                
                // Handle promosi
                if (promotion && piece.toLowerCase() === 'p') {
                    // Promosi pawn
                    const color = piece === piece.toUpperCase() ? 'white' : 'black';
                    const promotedPiece = color === 'white' ? promotion.toUpperCase() : promotion.toLowerCase();
                    boardData[toRow][toCol] = promotedPiece;
                } else {
                    boardData[toRow][toCol] = piece;
                }
                
                // Perbarui tampilan
                updateBoard();
                
                // Tambahkan ke riwayat
                const moveNotation = getMoveNotation(fromRow, fromCol, toRow, toCol, promotion);
                addMoveToHistory(moveNotation);
                
                // Sembunyikan loading
                loadingDiv.style.display = 'none';
                
                // Ganti pemain
                currentPlayer = currentPlayer === 'white' ? 'black' : 'white';
                updateStatus();
            }
            
            // Fungsi untuk mendapatkan notasi langkah (diperbarui untuk handle promosi)
            function getMoveNotation(fromRow, fromCol, toRow, toCol, promotion = null) {
                const files = 'abcdefgh';
                const ranks = '87654321';
                
                const piece = boardData[toRow][toCol];
                const isPawn = piece.toLowerCase() === 'p';
                const isCapture = boardData[toRow][toCol] !== '';
                
                let notation = '';
                
                if (!isPawn) {
                    notation += piece.toUpperCase();
                }
                
                if (isCapture) {
                    if (isPawn) {
                        notation += files[fromCol];
                    }
                    notation += 'x';
                }
                
                notation += files[toCol] + ranks[toRow];
                
                // Tambahkan notasi promosi jika ada
                if (promotion) {
                    notation += '=' + promotion.toUpperCase();
                }
                
                return notation;
            }
            
            // Inisialisasi papan
            function initializeBoard() {
                initialize2DBoard();
                initialize3DBoard();
                updateViewMode();
            }
            
            // Inisialisasi papan 2D
            function initialize2DBoard() {
                board2d.innerHTML = '';
                
                for (let row = 0; row < BOARD_SIZE; row++) {
                    for (let col = 0; col < BOARD_SIZE; col++) {
                        const square = document.createElement('div');
                        square.classList.add('square');
                        square.classList.add((row + col) % 2 === 0 ? 'light' : 'dark');
                        square.dataset.row = row;
                        square.dataset.col = col;
                        
                        square.style.position = 'absolute';
                        square.style.width = '12.5%';
                        square.style.height = '12.5%';
                        square.style.left = `${col * 12.5}%`;
                        square.style.top = `${row * 12.5}%`;
                        square.style.display = 'flex';
                        square.style.alignItems = 'center';
                        square.style.justifyContent = 'center';
                        
                        const piece = initialPosition[row][col];
                        if (piece) {
                            const pieceElement = document.createElement('div');
                            pieceElement.classList.add('piece');
                            pieceElement.dataset.piece = piece;
                            pieceElement.dataset.row = row;
                            pieceElement.dataset.col = col;
                            pieceElement.style.backgroundImage = `url(${getPieceImageUrl(piece)})`;
                            
                            pieceElement.addEventListener('click', handlePieceClick);
                            square.appendChild(pieceElement);
                        }
                        
                        square.addEventListener('click', handleSquareClick);
                        board2d.appendChild(square);
                    }
                }
            }
            
            // Inisialisasi papan 3D
            function initialize3DBoard() {
                board3d.innerHTML = '';
                
                for (let row = 0; row < BOARD_SIZE; row++) {
                    for (let col = 0; col < BOARD_SIZE; col++) {
                        const square = document.createElement('div');
                        square.classList.add('square');
                        square.classList.add((row + col) % 2 === 0 ? 'light' : 'dark');
                        square.dataset.row = row;
                        square.dataset.col = col;
                        
                        square.style.left = `${col * 12.5}%`;
                        square.style.top = `${row * 12.5}%`;
                        
                        const piece = initialPosition[row][col];
                        if (piece) {
                            const pieceElement = document.createElement('div');
                            pieceElement.classList.add('piece');
                            pieceElement.classList.add(piece === piece.toUpperCase() ? 'white' : 'black');
                            pieceElement.dataset.piece = piece;
                            pieceElement.dataset.row = row;
                            pieceElement.dataset.col = col;
                            pieceElement.style.backgroundImage = `url(${getPieceImageUrl(piece)})`;
                            
                            pieceElement.addEventListener('click', handlePieceClick);
                            square.appendChild(pieceElement);
                        }
                        
                        square.addEventListener('click', handleSquareClick);
                        board3d.appendChild(square);
                    }
                }
            }
            
            // Mendapatkan URL gambar untuk bidak
            function getPieceImageUrl(piece) {
                const isWhite = piece === piece.toUpperCase();
                const pieceType = piece.toLowerCase();
                const color = isWhite ? 'white' : 'black';
                
                switch(pieceType) {
                    case 'k': return PIECE_IMAGES[color].king;
                    case 'q': return PIECE_IMAGES[color].queen;
                    case 'r': return PIECE_IMAGES[color].rook;
                    case 'b': return PIECE_IMAGES[color].bishop;
                    case 'n': return PIECE_IMAGES[color].knight;
                    case 'p': return PIECE_IMAGES[color].pawn;
                    default: return '';
                }
            }
            
            // Memperbarui mode tampilan (2D atau 3D)
            function updateViewMode() {
                const mode = viewModeSelect.value;
                
                if (mode === '2d') {
                    board2d.style.display = 'block';
                    board3d.style.display = 'none';
                } else {
                    board2d.style.display = 'none';
                    board3d.style.display = 'block';
                }
            }
            
            // Menangani klik pada bidak
            function handlePieceClick(event) {
                if (!gameActive) return;
                if (currentPlayer !== playerSide) return;
                
                const piece = event.target;
                const row = parseInt(piece.dataset.row);
                const col = parseInt(piece.dataset.col);
                
                // Jika sudah ada bidak yang dipilih, lakukan move
                if (selectedPiece) {
                    movePiece(selectedPiece.row, selectedPiece.col, row, col);
                    return;
                }
                
                // Jika belum ada bidak yang dipilih, pilih bidak ini
                const pieceColor = boardData[row][col] === boardData[row][col].toUpperCase() ? 'white' : 'black';
                
                if (pieceColor === playerSide) {
                    selectedPiece = { row, col, element: piece };
                    piece.classList.add('selected');
                }
                
                event.stopPropagation();
            }
            
            // Menangani klik pada kotak
            function handleSquareClick(event) {
                if (!gameActive) return;
                if (currentPlayer !== playerSide) return;
                if (!selectedPiece) return;
                
                const row = parseInt(event.currentTarget.dataset.row);
                const col = parseInt(event.currentTarget.dataset.col);
                
                movePiece(selectedPiece.row, selectedPiece.col, row, col);
            }
            
            // Memindahkan bidak
            function movePiece(fromRow, fromCol, toRow, toCol) {
                // Validasi move sederhana
                if (fromRow === toRow && fromCol === toCol) {
                    resetSelection();
                    return;
                }
                
                // Lakukan move
                const piece = boardData[fromRow][fromCol];
                boardData[fromRow][fromCol] = '';
                boardData[toRow][toCol] = piece;
                
                // Perbarui tampilan
                updateBoard();
                
                // Tambahkan ke riwayat
                const moveNotation = getMoveNotation(fromRow, fromCol, toRow, toCol);
                addMoveToHistory(moveNotation);
                
                // Reset seleksi
                resetSelection();
                
                // Ganti pemain
                currentPlayer = currentPlayer === 'white' ? 'black' : 'white';
                updateStatus();
                
                // Jika giliran bot, minta move bot
                if (gameActive && currentPlayer !== playerSide) {
                    getBotMove();
                }
            }
            
            // Menambah langkah ke riwayat
            function addMoveToHistory(move) {
                moveHistory.push(move);
                
                const moveElement = document.createElement('div');
                moveElement.classList.add('move');
                moveElement.textContent = `${moveHistory.length}. ${move}`;
                
                if (moveHistory.length % 2 === 1) {
                    if (moveHistoryDiv.children.length % 2 === 0) {
                        moveHistoryDiv.innerHTML = '';
                    }
                    moveHistoryDiv.appendChild(moveElement);
                } else {
                    moveHistoryDiv.appendChild(moveElement);
                }
            }
            
            // Mereset seleksi bidak
            function resetSelection() {
                if (selectedPiece) {
                    selectedPiece.element.classList.remove('selected');
                    selectedPiece = null;
                }
            }
            
            // Memperbarui tampilan papan
            function updateBoard() {
                // Perbarui papan 2D
                const squares2d = board2d.querySelectorAll('.square');
                squares2d.forEach(square => {
                    const row = parseInt(square.dataset.row);
                    const col = parseInt(square.dataset.col);
                    
                    // Hapus semua bidak di kotak ini
                    square.innerHTML = '';
                    
                    // Tambahkan bidak baru jika ada
                    const piece = boardData[row][col];
                    if (piece) {
                        const pieceElement = document.createElement('div');
                        pieceElement.classList.add('piece');
                        pieceElement.dataset.piece = piece;
                        pieceElement.dataset.row = row;
                        pieceElement.dataset.col = col;
                        pieceElement.style.backgroundImage = `url(${getPieceImageUrl(piece)})`;
                        
                        pieceElement.addEventListener('click', handlePieceClick);
                        square.appendChild(pieceElement);
                    }
                });
                
                // Perbarui papan 3D
                const squares3d = board3d.querySelectorAll('.square');
                squares3d.forEach(square => {
                    const row = parseInt(square.dataset.row);
                    const col = parseInt(square.dataset.col);
                    
                    // Hapus semua bidak di kotak ini
                    square.innerHTML = '';
                    
                    // Tambahkan bidak baru jika ada
                    const piece = boardData[row][col];
                    if (piece) {
                        const pieceElement = document.createElement('div');
                        pieceElement.classList.add('piece');
                        pieceElement.classList.add(piece === piece.toUpperCase() ? 'white' : 'black');
                        pieceElement.dataset.piece = piece;
                        pieceElement.dataset.row = row;
                        pieceElement.dataset.col = col;
                        pieceElement.style.backgroundImage = `url(${getPieceImageUrl(piece)})`;
                        
                        pieceElement.addEventListener('click', handlePieceClick);
                        square.appendChild(pieceElement);
                    }
                });
            }
            
            // Memperbarui status permainan
            function updateStatus() {
                statusDiv.textContent = `Status: ${currentPlayer === playerSide ? 'Giliran Anda' : 'Giliran Bot'}`;
            }
            
            // Meminta langkah dari bot menggunakan WebSocket
            function getBotMove() {
                if (!isWebSocketConnected) {
                    showError('WebSocket tidak terhubung. Silakan sambungkan terlebih dahulu.');
                    return;
                }
                
                loadingDiv.style.display = 'block';
                errorDiv.style.display = 'none';
                
                // Konversi boardData ke FEN
                let fen = '';
                let emptyCount = 0;
                
                for (let row = 0; row < BOARD_SIZE; row++) {
                    for (let col = 0; col < BOARD_SIZE; col++) {
                        const piece = boardData[row][col];
                        if (piece === '') {
                            emptyCount++;
                        } else {
                            if (emptyCount > 0) {
                                fen += emptyCount;
                                emptyCount = 0;
                            }
                            fen += piece;
                        }
                    }
                    
                    if (emptyCount > 0) {
                        fen += emptyCount;
                        emptyCount = 0;
                    }
                    
                    if (row < BOARD_SIZE - 1) {
                        fen += '/';
                    }
                }
                
                // Tambahkan info giliran, hak rokade, dll.
                fen += ` ${currentPlayer[0]} - - 0 1`;
                
                // Kirim permintaan analisis ke WebSocket
                const success = requestAnalysis(fen);
                
                if (!success) {
                    loadingDiv.style.display = 'none';
                }
            }
            
            // Memperbarui tampilan evaluasi
            function updateEvaluation(score) {
                // Konversi score ke persentase (dari -10 sampai +10 menjadi 0% sampai 100%)
                const percentage = Math.min(Math.max((score + 10) * 5, 0), 100);
                
                evalFillDiv.style.width = `${percentage}%`;
                
                let evalText = `${score.toFixed(1)} `;
                if (score > 1.0) evalText += '(Putih unggul jelas)';
                else if (score > 0.3) evalText += '(Putih unggul)';
                else if (score > 0.1) evalText += '(Putih sedikit unggul)';
                else if (score > -0.1) evalText += '(Setara)';
                else if (score > -0.3) evalText += '(Hitam sedikit unggul)';
                else if (score > -1.0) evalText += '(Hitam unggul)';
                else evalText += '(Hitam unggul jelas)';
                
                evalTextDiv.textContent = evalText;
            }
            
            // Menampilkan error
            function showError(message) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                
                // Sembunyikan error setelah 5 detik
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 5000);
            }
            
            // Memulai game baru
            function startNewGame() {
                // Reset board
                boardData = JSON.parse(JSON.stringify(initialPosition));
                selectedPiece = null;
                moveHistory = [];
                moveHistoryDiv.innerHTML = '';
                errorDiv.style.display = 'none';
                
                // Set pemain
                playerSide = playerSideSelect.value;
                currentPlayer = 'white';
                
                // Reset evaluasi
                updateEvaluation(0);
                
                // Perbarui tampilan
                updateBoard();
                updateStatus();
                
                // Aktifkan game
                gameActive = true;
                
                // Jika pemain memilih hitam, minta langkah bot pertama
                if (playerSide === 'black') {
                    currentPlayer = 'white'; // Bot mulai pertama
                    getBotMove();
                }
            }
            
            // Event listeners
            viewModeSelect.addEventListener('change', updateViewMode);
            newGameBtn.addEventListener('click', startNewGame);
            connectWsBtn.addEventListener('click', connectWebSocket);
            
            // Inisialisasi
            initializeBoard();
        });
    </script>
</body>
</html>
